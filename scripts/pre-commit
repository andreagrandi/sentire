#!/bin/bash
# Pre-commit hook for Go formatting
# This script automatically formats staged Go files using gofmt

# Get list of staged Go files
staged_go_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$')

# Exit early if no Go files are staged
if [ -z "$staged_go_files" ]; then
    exit 0
fi

echo "Formatting staged Go files..."

# Format each staged Go file
formatted_files=()
for file in $staged_go_files; do
    # Check if file still exists (might have been deleted)
    if [ -f "$file" ]; then
        # Format the file with gofmt -s (simplify)
        gofmt -s -w "$file"
        
        # Check if formatting made changes
        if ! git diff --quiet "$file"; then
            formatted_files+=("$file")
            # Re-stage the formatted file
            git add "$file"
        fi
    fi
done

# Report what was formatted
if [ ${#formatted_files[@]} -gt 0 ]; then
    echo "Formatted and re-staged the following files:"
    for file in "${formatted_files[@]}"; do
        echo "  - $file"
    done
fi

exit 0